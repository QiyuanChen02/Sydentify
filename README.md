# Sydentify

A Python-based tool for analyzing synaptic connections in neuroscience imaging data. Sydentify processes pre-synaptic and post-synaptic neuron data from CellProfiler to identify, validate, and visualize synapses with density mapping capabilities.

## Features

- **Synapse Identification**: Automatically identifies synapses by finding nearest neighbors between pre-synaptic and post-synaptic neurons
- **Density Analysis**: Generates density maps showing synapse distribution across the image
- **Validation**: Filters and validates synapses based on distance thresholds and color detection
- **Visualization**: Creates interactive visualizations and static images of synapse locations
- **Excel Output**: Exports detailed synapse data including coordinates, distances, and validation status

## Requirements

- Python 3.x
- Required packages (install via `requirements.txt`):
  - matplotlib==3.7.2
  - mplcursors==0.5.2
  - numpy==1.23.2
  - pandas==2.0.3
  - Pillow==10.4.0

## Installation

1. Clone the repository:
```bash
git clone https://github.com/QiyuanChen02/Sydentify.git
cd Sydentify
```

2. Install dependencies:
```bash
pip install -r requirements.txt
```

## Input Data Structure

Organize your input data in the `input/` folder with the following structure:

```
input/
├── image1/
│   ├── pre.csv      # Pre-synaptic neuron data from CellProfiler
│   ├── post.csv     # Post-synaptic neuron data from CellProfiler
│   └── image.png    # Original microscopy image (optional but recommended)
├── image2/
│   ├── pre.csv
│   ├── post.csv
│   └── image.png
└── ...
```

### CSV File Format
The CSV files should contain coordinate and area data for each detected neuron, generated by CellProfiler.

## Usage

### Basic Usage

Run the main analysis script on all folders in the `input/` directory:

```bash
python main.py
```

This will automatically:
1. Process each folder in the `input/` directory
2. Perform density analysis
3. Perform synapse identification and validation
4. Generate output images and Excel files in the corresponding `output/` subfolders

### Analyzing Individual Images

#### Density Analysis Only
```bash
python densityAnalyser.py
```
Enter the folder name when prompted (e.g., `image1`).

#### Synapse Analysis Only
```bash
python showSynapse.py
```
Enter the folder name when prompted.

## Output

Results are saved in the `output/` folder with corresponding subfolder names:

```
output/
├── image1/
│   ├── densityImage.png    # Density heatmap overlay
│   ├── synapseImage.png    # Synapse locations marked on image
│   └── synapseData.xlsx    # Detailed synapse data
└── image2/
    └── ...
```

### Output Files

- **densityImage.png**: Visual representation of synapse density across the image using a grid-based heatmap
- **synapseImage.png**: Original image with validated synapses marked
- **synapseData.xlsx**: Excel file containing:
  - Post-synaptic coordinates
  - Closest pre-synaptic neighbor information
  - Distances between pairs
  - Calculated synapse centers
  - Validation status

## Configuration

Edit `helpers/constants.py` to customize analysis parameters:

### Key Parameters

- **GRIDSIZE** (default: 100): Size in pixels of each grid block for density analysis. Larger values create coarser grids.
  
- **COLOUR_THRESHOLD** (default: 150): Maximum RGB distance for color detection of synaptic markers in the image.

- **DISTANCE_THRESHOLD** (default: 2): Maximum pixel distance to find corresponding colored pixels in the original image.

- **PRE_POST_DIST_LOWER_THRESHOLD** (default: -2): Minimum distance (minus radii) between pre and post neurons for valid synapses.

- **PRE_POST_DIST_UPPER_THRESHOLD** (default: 3): Maximum distance (minus radii) between pre and post neurons for valid synapses.

- **POINTS_COLOUR** (default: cyan): RGB color for marking synapses on output images.

- **DENSITY_COLOUR** (default: white): RGB color for highest density areas on density maps.

## How It Works

1. **Data Loading**: Reads pre-synaptic and post-synaptic coordinates from CSV files
2. **Point Filtering**: Validates points against the original microscopy image using color thresholds
3. **Neighbor Finding**: Calculates nearest neighbors between pre and post synaptic points
4. **Synapse Calculation**: Computes synapse centers based on neuron radii and distances
5. **Validation**: Filters synapses based on distance criteria and mutual nearest-neighbor relationships
6. **Grid Generation**: Divides image into grid and counts synapses per cell for density analysis
7. **Visualization**: Generates heatmaps and marked images showing synapse locations and densities
8. **Export**: Saves results as images and Excel spreadsheets

### Synapse Center Calculation

The synapse center is calculated as a weighted point between the pre and post synaptic neurons based on their radii and the distance between them, representing the likely location of the synaptic connection.

### Validation Criteria

A synapse is considered valid if:
- The pre and post neurons are mutual nearest neighbors
- The distance between neurons (minus their radii) falls within the configured threshold range
- The points correspond to detectable markers in the original image

## License

This project is available for academic and research use.

## Authors

- Qiyuan Chen
- William Yang

## Support

For issues or questions, please open an issue on the GitHub repository.

